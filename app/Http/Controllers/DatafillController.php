<?php

namespace App\Http\Controllers;

use App\Models\Asset;
use App\Models\ChartOfAccount;
use App\Models\Customer;
use App\Models\CustomerLog;
use App\Models\Journal;
use App\Models\Lookup;
use App\Models\Meter;
use App\Models\Owner;
use App\Models\Billing;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Http\Request;
use App\Http\Controllers\LogController as Logs;
use Illuminate\Support\Facades\Auth;
use Yajra\DataTables\Facades\DataTables;
use App\Http\PigeonHelpers\otherHelper;
use Excel;
use DB;
use DateTime;


class DatafillController extends Controller
{
    function fillOwnerId(){
        set_time_limit(0);
        $journal = Billing::orderBy('id','asc')->get();
        foreach ($journal as $row){
                if($row->bill_type=='Electricity'){
                    $asset = Meter::where('asset_no',$row['shop_no'])->first();
                }else{
                    $asset = Asset::where('asset_no',$row['shop_no'])->first();
                }
                if($row->owner_id==0 || $row->owner_id==''){
                    $bill = Billing::find($row->id);
                    $bill->owner_id=$asset->owner_id??0;
                    $bill->save();
                }
            Journal::where('ref_id',$row->id)->where('ref_module',$row->module)->update(['owner_id'=>$asset->owner_id??0]);
        }
        echo "process complete";
    }

    public function addFineFromBackup(){
        $r = "SELECT
*
FROM
`billings_copy`
WHERE id IN (
    4292,
    4293,
    4297,
    4306,
    4307,
    4308,
    4309,
    4318,
    4319,
    4320,
    4321,
    4322,
    4323,
    4331,
    4332,
    4333,
    4334,
    4367,
    4368,
    4437,
    4438,
    4439,
    4440,
    4441,
    4442,
    4443,
    4444,
    4445,
    4446,
    4447,
    4448,
    4449,
    4451,
    4452,
    4499,
    4513,
    4554,
    4555,
    4556,
    4557,
    4627,
    4713,
    4714,
    4772,
    4773,
    4774,
    4889,
    5367,
    5368,
    5512,
    5513,
    5627,
    5628,
    5629,
    5630,
    5631,
    5632,
    5633
  )";
        $data = DB::select($r);
        foreach ($data as $row){
            $bill = Billing::find( $row->id);
            $bill->fine_amount = $row->fine_amount;
            $bill->fixed_fine = $row->fixed_fine;
            $bill->save();
            echo $row->fine_amount. ' '. $row->id . ' <br>';
        }
    }

    public function removeFixedFine(){

        $date = date('Y-m-d');
        $billing = Billing::leftjoin('billing_details', 'billings.id', '=', 'billing_details.billing_id')
//            ->where('payment_status', '<>', 1)
//            ->where('module', 'Billing')
//            ->where('bill_type', 'Service Charge')
//            ->where('fine_amount', '>=',500)
            ->whereIn('billings.id',[4297,
                4307,
                4308,
                4367,
                4368,
                4437,
                4438,
                4439,
                4440,
                4441,
                4442,
                4443,
                4444,
                4445,
                4446,
                4447,
                4448,
                4449,
                4451,
                4452,
                4499,
                4513,
                4554,
                4555,
                4556,
                4557,
                4627,
                4713,
                4714,
                4772,
                4773,
                4774,
                4889,
                5294,
                5295,
                5296,
                5297,
                5298,
                5299,
                5300,
                5301,
                5302,
                5303,
                5304,
                5307,
                5367,
                5368,
                5369,
                5370,
                5398,
                5399,
                5400,
                5401,
                5402,
                5403,
                5404,
                5405,
                5406,
                5407,
                5408,
                5409,
                5410,
                5411,
                5412,
                5413,
                5414,
                5415,
                5416,
                5417,
                5418,
                5419,
                5420,
                5421,
                5422,
                5423,
                5424,
                5425,
                5426,
                5427,
                5428,
                5429,
                5430,
                5431,
                5432,
                5433,
                5434,
                5435,
                5436,
                5437,
                5438,
                5439,
                5440,
                5441,
                5442,
                5445,
                5446,
                5447,
                5448,
                5449,
                5450,
                5451,
                5452,
                5453,
                5454,
                5455,
                5456,
                5457,
                5458,
                5459,
                5460,
                5461,
                5462,
                5463,
                5464,
                5465,
                5466,
                5467,
                5468,
                5469,
                5470,
                5471,
                5472,
                5473,
                5474,
                5476,
                5512,
                5513,
                5530,
                5531,
                5532,
                5537,
                5539,
                5565,
                5566,
                5567,
                5568,
                5569,
                5570,
                5581,
                5584,
                5585,
                5586,
                5587,
                5588,
                5589,
                5590,
                5591,
                5592,
                5593,
                5594,
                5595,
                5596,
                5597,
                5598,
                5599,
                5600,
                5601,
                5602,
                5603,
                5604,
                5605,
                5606,
                5607,
                5608,
                5609,
                5610,
                5611,
                5612,
                5613,
                5614,
                5615,
                5616,
                5617,
                5618,
                5619,
                5620,
                5621,
                5622,
                5623,
                5624,
                5627,
                5628,
                5629,
                5630,
                5631,
                5632,
                5633,
                5634,
                5635,
                5636,
                5637,
                5638,
                5639,
                5640,
                5641,
                5642,
                5643,
                5644,
                5645,
                5646,
                5647,
                5648,
                5649,
                5650,
                5651,
                5652,
                5653,
                5654,
                5655,
                5656,
                5681,
                5682,
                5683,
                5684,
                5685,
                5686,
                5687,
                5688,
                5696,
                5706,
                5707,
                5708,
                5709,
                5753,
                5754,
                5755,
                5756,
                5757,
                5758,
                5759,
                5760,
                5761,
                5762,
                5763,
                5764,
                5765,
                5766,
                5767,
                5768,
                5773,
                5774,
                5775,
                5784,
                5785,
                5786,
                5787,
                5788,
                5792,
                5793,
                5794,
                5795,
                5796,
                5797,
                5798,
                5799,
                5800,
                5801,
                5802,
                5803,
                5804,
                5805,
                5806,
                5807,
                5808,
                5809,
                5810,
                5811,
                5812,
                5813,
                5814,
                5815,
                5824,
                5825,
                5826,
                5834,
                5835,
                5836,
                5940,
                5941,
                5976,
                5977,
                5978,
                5979,
                5980,
                5981,
                5982,
                5983,
                5984,
                5985,
                5986,
                5987,
                5988,
                5989,
                5990,
                5991,
                5992,
                5993,
                5994,
                5995,
                5996,
                5997,
                5998,
                5999,
                6000,
                6001,
                6002,
                6003,
                6004,
                6005,
                6006,
                6007,
                6008,
                6009,
                6010,
                6011,
                6012,
                6013,
                6014,
                6015,
                6016,
                6019,
                6031,
                6032,
                6703,
                6704,
                6705,
                6706,
                6707,
                6708,
                6709,
                6710,
                6711,
                6712,
                6713,
                6714,
                6715,
                6716,
                6717,
                6718,
                6719,
                6720,
                6721,
                6722,
                6723,
                6724,
                6725,
                6726,
                6727,
                6728,
                6729,
                6730,
                6731,
                6732,
                6733,
                6734,
                6735,
                6736,
                6737,
                6738,
                6739,
                6740,
                6741,
                6742,
                6743,
                6746,
                6818,
                6819,
                6820,
                6821,
                6822,
                6823,
                6826,
                6827,
                6828,
                6829,
                6830,
                6932,
                6933,
                6934,
                6937,
                6938,
                6939,
                6940,
                6943,
                6944,
                6945,
                6946,
                6947,
                6948,
                6949,
                6950,
                6951,
                6952,
                6953,
                6993,
                6994,
                6995,
                6996,
                6997,
                6998,
                6999,
                7000,
                7001,
                7002,
                7003,
                7004,
                7005,
                7006,
                7007,
                7008,
                7009,
                7010,
                7011,
                7012,
                7013,
                7014,
                7015,
                7016,
                7017,
                7018,
                7019,
                7020,
                7021,
                7022,
                7023,
                7024,
                7027,
                7028,
                7029,
                7030,
                7031,
                7032,
                7033,
                7034,
                7035,
                7036,
                7073,
                7074,
                7075,
                7078,
                7079,
                7080,
                7081,
                7082,
                7083,
                7084,
                7085,
                7086,
                7087,
                7088,
                7089,
                7090,
                7091,
                7092,
                7129,
                7130,
                7131,
                7132,
                7133,
                7134,
                7135,
                7136,
                7137,
                7138,
                7139,
                7140,
                7141,
                7142,
                7143,
                7144,
                7145,
                7148,
                7149,
                7150,
                7151,
                7152,
                7153,
                7154,
                7155,
                7156,
                7157,
                7158,
                7159,
                7160,
                7161,
                7162,
                7194,
                7195,
                7196,
                7197,
                7198,
                7199,
                7200,
                7201,
                7202,
                7203,
                7204,
                7205,
                7206,
                7207,
                7208,
                7209,
                7210,
                7211,
                7212,
                7213,
                7214,
                7215,
                7216,
                7217,
                7218,
                7219,
                7220,
                7221,
                7222,
                7223,
                7224,
                7225,
                7226,
                7227,
                7228,
                7229,
                7230,
                7231,
                7232,
                7233,
                7234,
                7235,
                7236,
                7237,
                7238,
                7239,
                7242,
                8016,
                8017,
                8018,
                8019,
                8022,
                8023,
                8024,
                8025,
                8026,
                8027,
                8028,
                8029,
                8030,
                8031,
                8032,
                8033,
                8034,
                8035,
                8036,
                8037,
                8080,
                8081,
                8082,
                8083,
                8084,
                8085,
                8086,
                8087,
                8088,
                8089,
                8090,
                8091,
                8094,
                8095,
                8096,
                8097,
                8098,
                8099,
                8100,
                8101,
                8102,
                8103,
                8104,
                8105,
                8106,
                8128,
                8129,
                8149,
                8150,
                8220,
                8221,
                8222,
                8223,
                8224,
                8225,
                8226,
                8227,
                8228,
                8229,
                8230,
                8233,
                8234,
                8235,
                8236,
                8237,
                8238,
                8239,
                8240,
                8241,
                8242,
                8243,
                8244,
                8245,
                8246,
                8247,
                8248,
                8301,
                8302,
                8303,
                8304,
                8305,
                8306,
                8307,
                8308,
                8309,
                8310,
                8311,
                8314,
                8315,
                8316,
                8317,
                8318,
                8319,
                8320,
                8321,
                8322,
                8323,
                8324,
                8325,
                8326,
                8327,
                8328,
                8329,
                8343,
                8344,
                8345,
                8346,
                8347,
                8348,
                8349,
                8350,
                8351,
                8352,
                8353,
                8354,
                8355,
                8356,
                8357,
                8358,
                8359,
                8360,
                8361,
                8362,
                8363,
                8384,
                8385,
                8386,
                8387,
                8388,
                8389,
                8390,
                8391,
                8392,
                8393,
                8394,
                8395,
                8396,
                8397,
                8398,
                8399,
                8400,
                8401,
                8402,
                8403,
                8404])
            ->selectRaw('billings.*,billing_details.ledger_id,billing_details.month')
            ->groupBy('billings.id')
            ->get();

        foreach ($billing as $row) {
            if ($row['ledger_id'] == 31 || $row['ledger_id'] == 32 || $row['ledger_id'] == 119) { // service charge
                $data['fixed_fine'] = 0;
                $data['month'] = 0;
                $percent_sc = $row['percent_sc'] + 3;
                $from = date_create($row['due_date']);//
                $to = date_create(date('Y-m-d'));

                $diff = date_diff($to, $from);
                $amount1 = 0;
                $date1 = '2023-01-01';
//                if ($diff->days >= 1) {
                    $fixed_fine = 500;
                    if ($row['fixed_fine'] != '' && $row['fixed_fine'] != 0) {
                        $amount = ($row['total'] + $row['fixed_fine']) * ($percent_sc / 100);
                        $amount1 = round($amount);
                        $amount = round(($amount + $row['fine_amount']));
                        $this->makeJournal($row, $amount1, 76);
                        $date1 = '2023-01-01';
                        $row['effective'] = '2023-01-01';
                        Billing::where('id', $row['id'])->update(
                            ['fine_status' => 0,
                                'next_due_date' => $date1,
                                'fixed_fine' => $fixed_fine,
                                'percent_sc' => $percent_sc,
                                'fine_amount' => $amount
                            ]
                        );
                    }

//                $this->makeJournal($row, 500, 75);
//                Billing::where('id', $row['id'])->update(
//                    ['fine_status' => 0,
//                        'next_due_date' =>$date1,
//                        'fixed_fine' => $fixed_fine,
//                        'percent_sc' => 0
//                    ]);


//                }

                //  $returnHTML = view('admin.bulk.service-form',$data)->render();
            }
        }
        return '<h2 style="text-align:Center;margin-top: 90px;">Apply auto increment Process Complete.....</h2>';


    }
    public function makeJournal($row, $amount, $type)
    {
        $coa = ChartOfAccount::getLedger($type); // Sales VAT Payable A/C
        $ledger_type = $coa->type;
        $ledger_code = trim($coa->system_code);
        $ledger_id = $coa->id;
        $group_name = $coa->group_name;
        $ledger_name = $coa->head;
        $income_id = $row['id'];
        $invoice_no = $row['invoice_no'];
        $effective = $row['effective'];//date('Y-m-d');
        $customer_name = trim($row['shop_name']);
        $issue_date = $row['issue_date'];
        $shop_no = $row['shop_no'];
        $meter_no = $row['meter_no'];
        $customer_id = $row['customer_id'];
        $month = $row['month'];
        $count = Billing::count();
        $count++;
        $voucher_no = "SV/" . date('y') . "/" . date('m') . '/' . $count;
        if ($row['ledger_id'] == 33) {
            $remarks = "Electricity bill Interest for Shop No# $shop_no for the month of $month for  meter no# " . $meter_no;

        } else {
            $remarks = "Service Charge  bill Interest for Shop No# $shop_no for the month of $month ";

        }
        $jv = array();
        $sub = array('ref_id' => $income_id, 'group_name' => $group_name, 'ledger_id' => $ledger_id, 'ledger_type' => $ledger_type,
            'ledger_code' => trim($ledger_code), 'post_date' => date('Y-m-d'), 'effective_date' => $effective,
            'transaction_type' => 'Billing', 'invoice_no' => $invoice_no, 'customer_name' => trim($customer_name), 'customer_id' => trim($customer_id),
            'remarks' => $remarks, 'ledger_head' => $ledger_name, 'date' => $issue_date, 'debit' => 0, 'is_fine' => 1,
            'credit' => $amount, 'voucher_no' => $voucher_no, 'ref_module' => 'Bulk Entry', 'shop_no' => $shop_no,
            'created_by' => '0');
        array_push($jv, $sub);

        // array_push($jv,$sub);

        $coa = ChartOfAccount::getLedger(36); //'Accounts Receivable'
        $ledger_type = $coa->type;
        $ledger_code = $coa->system_code;
        $ledger_id = $coa->id;
        $group_name = $coa->group_name;
        $sub = array('ref_id' => $income_id, 'group_name' => $group_name, 'ledger_id' => $ledger_id,
            'ledger_type' => $ledger_type, 'ledger_code' => $ledger_code, 'post_date' => date('Y-m-d'),
            'effective_date' => $effective, 'transaction_type' => 'Billing', 'invoice_no' => $invoice_no,
            'customer_name' => trim($customer_name),'customer_id' => trim($customer_id), 'remarks' => '', 'ledger_head' => 'Accounts Receivable',
            'date' => $issue_date, 'debit' => $amount, 'credit' => 0, 'voucher_no' => $voucher_no, 'is_fine' => 1,
            'shop_no' => $shop_no, 'ref_module' => 'Bulk Entry', 'created_by' => 0);
        array_push($jv, $sub);
        return Journal::insert($jv);

    }

    function makeJournalPre() {
        $bills  = Billing::leftjoin('billing_details','billing_details.billing_id','=','billings.id')
            ->SelectRaw('billings.*,billing_details.month,billing_details.ledger_id,billing_details.area_sft as area,billing_details.rate_sft as rate')
            ->whereIn('billings.id',[4297,
                4307,
                4308,
                4367,
                4368,
                4437,
                4438,
                4439,
                4440,
                4441,
                4442,
                4443,
                4444,
                4445,
                4446,
                4447,
                4448,
                4449,
                4451,
                4452,
                4499,
                4513,
                4554,
                4555,
                4556,
                4557,
                4627,
                4713,
                4714,
                4772,
                4773,
                4774,
                4889,
                5294,
                5295,
                5296,
                5297,
                5298,
                5299,
                5300,
                5301,
                5302,
                5303,
                5304,
                5307,
                5367,
                5368,
                5369,
                5370,
                5398,
                5399,
                5400,
                5401,
                5402,
                5403,
                5404,
                5405,
                5406,
                5407,
                5408,
                5409,
                5410,
                5411,
                5412,
                5413,
                5414,
                5415,
                5416,
                5417,
                5418,
                5419,
                5420,
                5421,
                5422,
                5423,
                5424,
                5425,
                5426,
                5427,
                5428,
                5429,
                5430,
                5431,
                5432,
                5433,
                5434,
                5435,
                5436,
                5437,
                5438,
                5439,
                5440,
                5441,
                5442,
                5445,
                5446,
                5447,
                5448,
                5449,
                5450,
                5451,
                5452,
                5453,
                5454,
                5455,
                5456,
                5457,
                5458,
                5459,
                5460,
                5461,
                5462,
                5463,
                5464,
                5465,
                5466,
                5467,
                5468,
                5469,
                5470,
                5471,
                5472,
                5473,
                5474,
                5476,
                5512,
                5513,
                5530,
                5531,
                5532,
                5537,
                5539,
                5565,
                5566,
                5567,
                5568,
                5569,
                5570,
                5581,
                5584,
                5585,
                5586,
                5587,
                5588,
                5589,
                5590,
                5591,
                5592,
                5593,
                5594,
                5595,
                5596,
                5597,
                5598,
                5599,
                5600,
                5601,
                5602,
                5603,
                5604,
                5605,
                5606,
                5607,
                5608,
                5609,
                5610,
                5611,
                5612,
                5613,
                5614,
                5615,
                5616,
                5617,
                5618,
                5619,
                5620,
                5621,
                5622,
                5623,
                5624,
                5627,
                5628,
                5629,
                5630,
                5631,
                5632,
                5633,
                5634,
                5635,
                5636,
                5637,
                5638,
                5639,
                5640,
                5641,
                5642,
                5643,
                5644,
                5645,
                5646,
                5647,
                5648,
                5649,
                5650,
                5651,
                5652,
                5653,
                5654,
                5655,
                5656,
                5681,
                5682,
                5683,
                5684,
                5685,
                5686,
                5687,
                5688,
                5696,
                5706,
                5707,
                5708,
                5709,
                5753,
                5754,
                5755,
                5756,
                5757,
                5758,
                5759,
                5760,
                5761,
                5762,
                5763,
                5764,
                5765,
                5766,
                5767,
                5768,
                5773,
                5774,
                5775,
                5784,
                5785,
                5786,
                5787,
                5788,
                5792,
                5793,
                5794,
                5795,
                5796,
                5797,
                5798,
                5799,
                5800,
                5801,
                5802,
                5803,
                5804,
                5805,
                5806,
                5807,
                5808,
                5809,
                5810,
                5811,
                5812,
                5813,
                5814,
                5815,
                5824,
                5825,
                5826,
                5834,
                5835,
                5836,
                5940,
                5941,
                5976,
                5977,
                5978,
                5979,
                5980,
                5981,
                5982,
                5983,
                5984,
                5985,
                5986,
                5987,
                5988,
                5989,
                5990,
                5991,
                5992,
                5993,
                5994,
                5995,
                5996,
                5997,
                5998,
                5999,
                6000,
                6001,
                6002,
                6003,
                6004,
                6005,
                6006,
                6007,
                6008,
                6009,
                6010,
                6011,
                6012,
                6013,
                6014,
                6015,
                6016,
                6019,
                6031,
                6032,
                6703,
                6704,
                6705,
                6706,
                6707,
                6708,
                6709,
                6710,
                6711,
                6712,
                6713,
                6714,
                6715,
                6716,
                6717,
                6718,
                6719,
                6720,
                6721,
                6722,
                6723,
                6724,
                6725,
                6726,
                6727,
                6728,
                6729,
                6730,
                6731,
                6732,
                6733,
                6734,
                6735,
                6736,
                6737,
                6738,
                6739,
                6740,
                6741,
                6742,
                6743,
                6746,
                6818,
                6819,
                6820,
                6821,
                6822,
                6823,
                6826,
                6827,
                6828,
                6829,
                6830,
                6932,
                6933,
                6934,
                6937,
                6938,
                6939,
                6940,
                6943,
                6944,
                6945,
                6946,
                6947,
                6948,
                6949,
                6950,
                6951,
                6952,
                6953,
                6993,
                6994,
                6995,
                6996,
                6997,
                6998,
                6999,
                7000,
                7001,
                7002,
                7003,
                7004,
                7005,
                7006,
                7007,
                7008,
                7009,
                7010,
                7011,
                7012,
                7013,
                7014,
                7015,
                7016,
                7017,
                7018,
                7019,
                7020,
                7021,
                7022,
                7023,
                7024,
                7027,
                7028,
                7029,
                7030,
                7031,
                7032,
                7033,
                7034,
                7035,
                7036,
                7073,
                7074,
                7075,
                7078,
                7079,
                7080,
                7081,
                7082,
                7083,
                7084,
                7085,
                7086,
                7087,
                7088,
                7089,
                7090,
                7091,
                7092,
                7129,
                7130,
                7131,
                7132,
                7133,
                7134,
                7135,
                7136,
                7137,
                7138,
                7139,
                7140,
                7141,
                7142,
                7143,
                7144,
                7145,
                7148,
                7149,
                7150,
                7151,
                7152,
                7153,
                7154,
                7155,
                7156,
                7157,
                7158,
                7159,
                7160,
                7161,
                7162,
                7194,
                7195,
                7196,
                7197,
                7198,
                7199,
                7200,
                7201,
                7202,
                7203,
                7204,
                7205,
                7206,
                7207,
                7208,
                7209,
                7210,
                7211,
                7212,
                7213,
                7214,
                7215,
                7216,
                7217,
                7218,
                7219,
                7220,
                7221,
                7222,
                7223,
                7224,
                7225,
                7226,
                7227,
                7228,
                7229,
                7230,
                7231,
                7232,
                7233,
                7234,
                7235,
                7236,
                7237,
                7238,
                7239,
                7242,
                8016,
                8017,
                8018,
                8019,
                8022,
                8023,
                8024,
                8025,
                8026,
                8027,
                8028,
                8029,
                8030,
                8031,
                8032,
                8033,
                8034,
                8035,
                8036,
                8037,
                8080,
                8081,
                8082,
                8083,
                8084,
                8085,
                8086,
                8087,
                8088,
                8089,
                8090,
                8091,
                8094,
                8095,
                8096,
                8097,
                8098,
                8099,
                8100,
                8101,
                8102,
                8103,
                8104,
                8105,
                8106,
                8128,
                8129,
                8149,
                8150,
                8220,
                8221,
                8222,
                8223,
                8224,
                8225,
                8226,
                8227,
                8228,
                8229,
                8230,
                8233,
                8234,
                8235,
                8236,
                8237,
                8238,
                8239,
                8240,
                8241,
                8242,
                8243,
                8244,
                8245,
                8246,
                8247,
                8248,
                8301,
                8302,
                8303,
                8304,
                8305,
                8306,
                8307,
                8308,
                8309,
                8310,
                8311,
                8314,
                8315,
                8316,
                8317,
                8318,
                8319,
                8320,
                8321,
                8322,
                8323,
                8324,
                8325,
                8326,
                8327,
                8328,
                8329,
                8343,
                8344,
                8345,
                8346,
                8347,
                8348,
                8349,
                8350,
                8351,
                8352,
                8353,
                8354,
                8355,
                8356,
                8357,
                8358,
                8359,
                8360,
                8361,
                8362,
                8363,
                8384,
                8385,
                8386,
                8387,
                8388,
                8389,
                8390,
                8391,
                8392,
                8393,
                8394,
                8395,
                8396,
                8397,
                8398,
                8399,
                8400,
                8401,
                8402,
                8403,
                8404])
            ->get();
        foreach ($bills as $row){
            $jv = array();
            $customer_name = $row['shop_name'];
            $invoice_no = $row['invoice_no'];
            $customer_id = $row['customer_id'];
            $voucher_no = $row['voucher_no'];

            $a = $row['area']*$row['rate'];
            $shop_no = $row['shop_no'];
            $remarks = "Service Charge for Shop No# $shop_no for the month of $row[month] for $row[area] sft @ Tk. $row[rate]";
            $income_id = $row['id'];
            $created_by = $row['created_by'];

            $effective = $row['journal_date'];
            $issue_date = $row['issue_date'];
            $post_date = $row['post_date'];

            $coa = ChartOfAccount::getLedger($row['ledger_id']);
            $ledger_type= $coa->type;
            $ledger_code= $coa->system_code;
            $ledger_id= $coa->id;
            $ledger_name= $coa->head;
            $group_name= $coa->group_name;

            $sub = array('ref_id'=>$income_id,'owner_id' => $row['owner_id'], 'group_name'=>$group_name,'ledger_id'=>$ledger_id,
                'ledger_type'=>$ledger_type,'ledger_code'=>$ledger_code,'post_date'=>$post_date,
                'effective_date'=>$effective, 'transaction_type'=> 'Billing','invoice_no'=>$invoice_no,
                'customer_name'=>$customer_name,'remarks'=>$remarks,'ledger_head'=>$ledger_name
            ,'date'=>$issue_date,'debit'=>0,'credit'=>$row['total'],'voucher_no'=>$voucher_no,
                'shop_no'=>$shop_no,'customer_id'=>$customer_id,
                'ref_module'=>'Billing','created_by'=>$created_by);
            array_push($jv,$sub);
            $file_amount = $row['fine_amount'];
            $created_by = $row['created_by'];

        $coa = ChartOfAccount::getLedger(75); //Service Charge Fixed Fine
        $ledger_type= $coa->type;
        $ledger_code= $coa->system_code;
        $ledger_id= $coa->id;
        $ledger_name= $coa->head;
        $group_name= $coa->group_name;
        $sub = array('ref_id'=>$income_id,'owner_id' => $row['owner_id'],'group_name'=>$group_name,'ledger_id'=>$ledger_id,
            'ledger_type'=>$ledger_type, 'ledger_code'=>$ledger_code, 'post_date'=>$post_date,
            'effective_date'=>$effective, 'transaction_type'=> 'Billing','invoice_no'=>$invoice_no,
            'customer_name'=>$customer_name,'remarks'=>'','ledger_head'=>$ledger_name,
            'date'=>$issue_date,'debit'=>0,'credit'=>$file_amount,'voucher_no'=>$voucher_no,
            'shop_no'=>$shop_no,'customer_id'=>$customer_id,
            'ref_module'=>'Billing','created_by'=>$created_by);
        if($file_amount!=0){
            array_push($jv,$sub);
        }
        $total = $file_amount+$row['total'];
        $coa = ChartOfAccount::getLedger(36); //'Accounts Receivable'
        $ledger_type = $coa->type;
        $ledger_code = $coa->system_code;
        $ledger_id = $coa->id;
        $ledger_name = $coa->head;
        $group_name= $coa->group_name;
        $sub =  array('ref_id'=>$income_id,'owner_id' => $row['owner_id'],'group_name'=>$group_name,'ledger_id'=>$ledger_id,
            'ledger_type'=>$ledger_type,'ledger_code'=>$ledger_code,'post_date'=>$post_date,
            'effective_date'=>$effective, 'transaction_type'=> 'Billing','invoice_no'=>$invoice_no,
            'customer_name'=>$customer_name,'shop_no'=>$shop_no,'customer_id'=>$customer_id,'remarks'=>'','ledger_head'=>$ledger_name,
            'date'=>$issue_date,'debit'=>($total),'credit'=>0,'voucher_no'=>$voucher_no,
            'ref_module'=>'Billing','created_by'=>$created_by);
        array_push($jv,$sub);
        Journal::insert($jv);

      }
        echo "process complete";
    }

}
